<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Inventaris</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --sidebar-width: 280px;
            --sidebar-width-mini: 80px;
        }
        body { background-color: #f0f2f5; }
        hr {
            border: none;
            height: 1px;
            color: #495057; 
            background-color: #495057;
        }
        .sidebar {
            width: var(--sidebar-width);
            background-color: #212529;
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            padding-top: 10px;
            color: white;
            transition: width 0.3s ease;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }
        .sidebar-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        .sidebar .sidebar-header {
            text-align: center;
            padding: 10px 0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar .sidebar-header .app-title { display: block; }

        .sidebar .user-profile {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-top: 1px solid #495057;
            border-bottom: 1px solid #495057;
        }
        .sidebar .user-profile .user-info {
            margin-left: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar .user-profile .user-info h6 { margin-bottom: 0; font-size: 0.9rem; }
        .sidebar .user-profile .user-info small { color: #adb5bd; font-size: 0.75rem; }

        .sidebar .nav-heading {
            padding: 15px 20px 5px 20px;
            font-size: 0.7rem;
            font-weight: bold;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
        }
        .sidebar .nav-link {
            color: #adb5bd;
            padding: 12px 20px;
            border-radius: 0.35rem;
            margin: 2px 10px;
            display: flex;
            align-items: center;
            white-space: nowrap;
            font-size: 13px;
        }
        .sidebar .nav-link .menu-text { display: inline; margin-left: 10px; }
        .sidebar .nav-link.active,
        .sidebar .nav-link:hover {
            background-color: #0d6efd;
            color: white;
        }
        .main-content { 
            margin-left: var(--sidebar-width); 
            padding: 0;
            transition: margin-left 0.3s ease;
        }
        .header {
            background-color: white;
            padding: 10px 30px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-area { padding: 30px; }
        
        body.sidebar-minimized .sidebar { width: var(--sidebar-width-mini); }
        body.sidebar-minimized .main-content { margin-left: var(--sidebar-width-mini); }
        body.sidebar-minimized .sidebar .sidebar-header .app-title,
        body.sidebar-minimized .sidebar .user-profile,
        body.sidebar-minimized .sidebar .nav-heading,
        body.sidebar-minimized .sidebar .nav-link .menu-text { display: none; }
        body.sidebar-minimized .sidebar .nav-link { justify-content: center; }
        
        @media (max-width: 992px) {
            body:not(.sidebar-minimized) { --sidebar-width: 80px; }
            body:not(.sidebar-minimized) .sidebar .sidebar-header .app-title,
            body:not(.sidebar-minimized) .sidebar .user-profile,
            body:not(.sidebar-minimized) .sidebar .nav-heading,
            body:not(.sidebar-minimized) .sidebar .nav-link .menu-text { display: none; }
            body:not(.sidebar-minimized) .sidebar .nav-link { justify-content: center; }
            body:not(.sidebar-minimized) .main-content { margin-left: var(--sidebar-width-mini); }
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 60px; height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Gaya baru untuk scrollable container */
        .scrollable-container {
            max-height: 280px; /* Kira-kira 5 baris */
            overflow-y: auto;
        }
    </style>
</head>
<body>

<!-- Pre-loader -->
<div id="app-loader" class="d-flex justify-content-center align-items-center" style="height:100vh; position:fixed; width:100%; background:#f0f2f5; z-index:9999;">
    <div class="loader"></div>
</div>

<div id="main-app" class="d-none">
    <div class="d-flex">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="bi bi-pc-display-horizontal" style="font-size: 23px;"></i>
                <i class="bi bi-file-earmark-text" style="font-size: 23px;"></i>
                <span style="font-size: 20px;" class="app-title ms-2"><b>Inventaris</b>Web</span>
            </div>
            
            <div class="sidebar-content">
                <!-- User Profile di Sidebar -->
                <div class="user-profile">
                    <img src="https://placehold.co/40x40/0d6efd/white?text=M" alt="User" class="rounded-circle" id="sidebar-user-avatar">
                    <div class="user-info">
                        <h6 id="sidebar-user-name">Memuat...</h6>
                        <small id="sidebar-user-email">Memuat...</small>
                    </div>
                </div>

                <ul class="nav flex-column" id="main-nav">
                    <li class="nav-heading">MAIN NAVIGATOR</li>
                    <li class="nav-item"><a class="nav-link active" data-page="dashboard" href="#"><i class="bi bi-speedometer2"></i><span class="menu-text">DASHBOARD</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-page="data-material" href="#"><i class="bi bi-box-seam"></i><span class="menu-text">DATA MATERIAL</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-page="data-komponen" href="#"><i class="bi bi-tools"></i><span class="menu-text">DATA KOMPONEN</span></a></li>
                    <li class="nav-item"><a class="nav-link" data-page="barang-keluar" href="#"><i class="bi bi-box-arrow-up-right"></i><span class="menu-text">BARANG KELUAR (TEMPORARY)</span></a></li>
                    <li class="nav-item"><a class="nav-link btn-logout" href="#"><i class="bi bi-box-arrow-right"></i><span class="menu-text">LOGOUT</span></a></li>
                </ul>
            </div>
        </div>

        <!-- KONTEN UTAMA -->
        <div class="main-content w-100">
            <div class="header">
                <button id="sidebar-toggle" class="btn btn-light"><i class="bi bi-list"></i></button>
                <div class="d-flex align-items-center">
                    <img src="https://placehold.co/32x32/0d6efd/white?text=M" alt="" width="32" height="32" class="rounded-circle me-2" id="header-user-avatar">
                    <strong class="me-3" id="header-user-name">Memuat...</strong>
                    <button type="button" class="btn btn-outline-danger btn-sm btn-logout">
                        <b><i class="bi bi-box-arrow-right me-1"></i><span>LOGOUT</span></b>
                    </button>
                </div>
            </div>
            <div class="content-area" id="content-area"></div>
        </div>
    </div>
</div>

<!-- Modal Generik untuk Tambah/Edit -->
<div class="modal fade" id="itemModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="itemModalLabel"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><form id="itemForm"></form></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" form="itemForm" class="btn btn-primary">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Konfirmasi Umum -->
<div class="modal fade" id="confirmActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="confirmActionTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="confirmActionBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS1mtdu6GkLG4X7yIv8e5BxmR7_rlMNLQ",
      authDomain: "project-kp-web-inventaris.firebaseapp.com",
      projectId: "project-kp-web-inventaris",
      storageBucket: "project-kp-web-inventaris.appspot.com",
      messagingSenderId: "180534737303",
      appId: "1:180534737303:web:4da196e5f791e2e1dcacd2",
      measurementId: "G-MZZ0K2PDCZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, user => {
        if (user) {
            document.getElementById('app-loader').classList.add('d-none');
            document.getElementById('main-app').classList.remove('d-none');
            initializeAppLogic(user);
        } else {
            window.location.href = new URL('login.html', window.location.href).href;
        }
    });

    function initializeAppLogic(user) {
        const contentArea = document.getElementById('content-area');
        const itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
        const itemForm = document.getElementById('itemForm');
        const confirmActionModal = new bootstrap.Modal(document.getElementById('confirmActionModal'));
        let currentActionInfo = { action: null, docId: null };
        let currentCollectionName = 'dashboard';

        // --- Perbarui Info User di UI ---
        const userDisplayName = user.displayName || user.email.split('@')[0];
        const userInitial = userDisplayName.charAt(0).toUpperCase();
        document.getElementById('sidebar-user-name').textContent = userDisplayName;
        document.getElementById('sidebar-user-email').textContent = user.email;
        document.getElementById('header-user-name').textContent = `${userDisplayName}`;
        const avatarUrl = `https://placehold.co/40x40/0d6efd/white?text=${userInitial}`;
        document.getElementById('sidebar-user-avatar').src = avatarUrl;
        document.getElementById('header-user-avatar').src = avatarUrl.replace('40x40', '32x32');
        
        // --- Fungsi Helper untuk Datalog ---
        async function writeLog(action, collectionName, itemData) {
            const logData = { action, collection: collectionName, details: itemData, user: user.email, timestamp: serverTimestamp() };
            try {
                await addDoc(collection(db, 'users', user.uid, 'logs'), logData);
            } catch (error) { console.error("Gagal menulis log:", error); }
        }

        // --- Event Listener Global ---
        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('.btn-logout, .btn-tambah, .btn-edit, .btn-delete, #clear-log-btn');
            if (!target) return;

            if (target.matches('.btn-logout')) {
                currentActionInfo = { action: 'logout' };
                document.getElementById('confirmActionTitle').textContent = 'Konfirmasi Logout';
                document.getElementById('confirmActionBody').textContent = 'Apakah Anda yakin ingin keluar dari aplikasi?';
                confirmActionModal.show();
            } else if (target.matches('.btn-tambah')) {
                const title = currentCollectionName.charAt(0).toUpperCase() + currentCollectionName.slice(1);
                document.getElementById('itemModalLabel').textContent = `Tambah ${title} Baru`;
                buildForm();
                itemModal.show();
            } else if (target.matches('.btn-edit')) {
                const docId = target.dataset.id;
                const docSnap = await getDoc(doc(db, 'users', user.uid, currentCollectionName, docId));
                if (docSnap.exists()) {
                    const title = currentCollectionName.charAt(0).toUpperCase() + currentCollectionName.slice(1);
                    document.getElementById('itemModalLabel').textContent = `Edit ${title}`;
                    buildForm({ id: docId, ...docSnap.data() });
                    itemModal.show();
                }
            } else if (target.matches('.btn-delete')) {
                currentActionInfo = { action: 'delete', docId: target.dataset.id };
                document.getElementById('confirmActionTitle').textContent = 'Konfirmasi Hapus';
                document.getElementById('confirmActionBody').textContent = 'Apakah Anda yakin ingin menghapus data ini secara permanen?';
                confirmActionModal.show();
            } else if (target.matches('#clear-log-btn')) {
                currentActionInfo = { action: 'clear_logs' };
                document.getElementById('confirmActionTitle').textContent = 'Konfirmasi Hapus Riwayat';
                document.getElementById('confirmActionBody').textContent = 'Apakah Anda yakin ingin menghapus semua riwayat aktivitas? Tindakan ini tidak dapat diurungkan.';
                confirmActionModal.show();
            }
        });

        document.getElementById('sidebar-toggle').addEventListener('click', () => document.body.classList.toggle('sidebar-minimized'));
        document.getElementById('main-nav').addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (link && link.dataset.page) { e.preventDefault(); navigate(link.dataset.page); }
        });

        // --- Logika Tombol Konfirmasi Modal ---
        document.getElementById('confirmActionBtn').addEventListener('click', async () => {
            const { action, docId } = currentActionInfo;
            if (action === 'logout') {
                signOut(auth);
            } else if (action === 'delete' && docId) {
                const docRef = doc(db, 'users', user.uid, currentCollectionName, docId);
                const docSnap = await getDoc(docRef);
                await deleteDoc(docRef);
                writeLog('Dihapus', currentCollectionName, docSnap.data());
            } else if (action === 'clear_logs') {
                const logsCollectionRef = collection(db, 'users', user.uid, 'logs');
                const logsSnapshot = await getDocs(logsCollectionRef);
                const batch = writeBatch(db);
                logsSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }
            confirmActionModal.hide();
            currentActionInfo = { action: null, docId: null };
        });

        // --- Router Halaman ---
        function navigate(page) {
            currentCollectionName = page.split('-').pop();
            document.querySelectorAll('#main-nav .nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`#main-nav .nav-link[data-page="${page}"]`).classList.add('active');
            if (page === 'dashboard') loadDashboardPage();
            else loadDataTablePage();
        }

        // --- Template & Form Builders ---
        async function loadDashboardPage() {
            contentArea.innerHTML = `
                <div class="row g-4">
                    <div class="col-md-6 col-lg-3"><div class="card text-white bg-primary"><div class="card-body d-flex justify-content-between align-items-center"><div><h5 class="card-title fs-2" id="total-material">...</h5><span>Total Material</span></div><i class="bi bi-box-seam" style="font-size: 3rem; opacity: 0.5;"></i></div></div></div>
                    <div class="col-md-6 col-lg-3"><div class="card text-white bg-success"><div class="card-body d-flex justify-content-between align-items-center"><div><h5 class="card-title fs-2" id="total-komponen">...</h5><span>Total Komponen</span></div><i class="bi bi-tools" style="font-size: 3rem; opacity: 0.5;"></i></div></div></div>
                    <div class="col-md-6 col-lg-3"><div class="card text-white bg-warning"><div class="card-body d-flex justify-content-between align-items-center"><div><h5 class="card-title fs-2" id="total-keluar">...</h5><span>Barang Keluar</span></div><i class="bi bi-box-arrow-up-right" style="font-size: 3rem; opacity: 0.5;"></i></div></div></div>
                    <div class="col-md-6 col-lg-3"><div class="card text-white bg-danger"><div class="card-body d-flex justify-content-between align-items-center"><div><h5 class="card-title fs-2">0</h5><span>Peringatan Stok</span></div><i class="bi bi-exclamation-triangle" style="font-size: 3rem; opacity: 0.5;"></i></div></div></div>
                </div></div></div>`;
            
            // Update stats
            ['material', 'komponen', 'keluar'].forEach(async (coll) => {
                const snapshot = await getDocs(collection(db, 'users', user.uid, coll));
                const elementId = coll === 'keluar' ? 'total-keluar' : `total-${coll}`;
                if(document.getElementById(elementId)) document.getElementById(elementId).textContent = snapshot.size;
            });
            
            // Render logs in real-time
            const logContainer = document.querySelector('#log-container ul');
            const q = query(collection(db, 'users', user.uid, 'logs'), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) { logContainer.innerHTML = '<li class="list-group-item text-muted text-center">Belum ada aktivitas.</li>'; return; }
                let logHtml = '';
                snapshot.forEach(doc => {
                    const log = doc.data();
                    const details = log.details || {};
                    const docName = details.nama || details.nama_barang || "Item";
                    const itemDetails = ` (Merk: ${details.merk || '-'}, Spek: ${details.spesifikasi || '-'}, Jml: ${details.jumlah || 0}, Ket: ${details.keterangan || '-'})`;
                    const date = log.timestamp?.toDate().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) || 'Baru saja';
                    logHtml += `<li class="list-group-item">[${date}] Item <strong>${docName}</strong> telah <strong>${log.action}</strong>.${itemDetails}</li>`;
                });
                logContainer.innerHTML = logHtml;
            });

            // Event listener untuk tombol clear log
            document.getElementById('clear-log-btn').addEventListener('click', () => {
                currentAction = 'clear_logs';
                document.getElementById('confirmActionTitle').textContent = 'Konfirmasi Hapus Riwayat';
                document.getElementById('confirmActionBody').textContent = 'Apakah Anda yakin ingin menghapus semua riwayat aktivitas? Tindakan ini tidak dapat diurungkan.';
                confirmActionModal.show();
            });
        }
        
        function loadDataTablePage() {
            const config = {
                'material': { title: 'Material', headers: ['NAMA MATERIAL', 'MERK', 'SPESIFIKASI', 'JUMLAH', 'KETERANGAN']},
                'komponen': { title: 'Komponen', headers: ['NAMA KOMPONEN', 'MERK', 'SPESIFIKASI', 'JUMLAH', 'KETERANGAN']},
                'keluar':   { title: 'Barang Keluar', headers: ['NAMA KOMPONEN', 'MERK', 'SPESIFIKASI', 'JUMLAH', 'KETERANGAN']}
            };
            const pageConfig = config[currentCollectionName];
            contentArea.innerHTML = `
                <nav aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="#">Home</a></li><li class="breadcrumb-item active">${pageConfig.title}</li></ol></nav>
                <div class="card mb-4"><div class="card-header bg-white d-flex justify-content-between align-items-center"><h5>Daftar ${pageConfig.title}</h5><button class="btn btn-primary btn-tambah"><i class="bi bi-plus-circle me-2"></i>Tambah ${pageConfig.title}</button></div><div class="card-body"><div class="table-responsive scrollable-container"><table class="table table-striped table-hover table-bordered"><thead class="table-dark"><tr><th>NO</th>${pageConfig.headers.map(h => `<th>${h}</th>`).join('')}<th>OPSI</th></tr></thead><tbody id="table-body"></tbody></table></div></div></div>
                <div class="card"><div class="card-header d-flex justify-content-between align-items-center">Riwayat Aktivitas ${pageConfig.title}<button class="btn btn-outline-secondary btn-sm" id="clear-log-btn"><i class="bi bi-trash me-1"></i> Bersihkan</button></div><div class="card-body p-0 scrollable-container" id="log-container"><ul class="list-group list-group-flush"></ul></div></div>`;
            renderTableData(pageConfig.headers);
            renderLogs();
        }

        function buildForm(data = {}) {
            const isEdit = !!data.id;
            let formHtml = `<input type="hidden" id="itemId" value="${data.id || ''}">`;
            if (currentCollectionName === 'komponen' || currentCollectionName === 'keluar') {
                formHtml += `
                    <div class="mb-3"><label class="form-label">Nama Barang</label><select class="form-select" id="nama_barang" required><option disabled ${!isEdit && 'selected'} value="">Pilih...</option>
                        <option>MCB</option>
                        <option>MCCB</option>
                        <option>Relay</option>
                        <option>Kontaktor</option>
                        <option>Thermal</option>
                        <option>Timer</option>
                        <option>Push Button</option>
                        <option>Pilot Lamp</option>
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label">Merk</label><select class="form-select" id="merk" required><option disabled ${!isEdit && 'selected'} value="">Pilih...</option>
                        <option>Autonics</option>
                        <option>Omron</option>
                        <option>Fuji Elektrik</option>
                        <option>GAE</option>
                        <option>ABB</option>
                        <option>LS</option>
                        <option>Schneider</option>
                        <option>Terasaki</option>
                        <option>Mitsubishi</option>
                        <option>IDEC</option>
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label">Spesifikasi</label><textarea class="form-control" id="spesifikasi">${data.spesifikasi || ''}</textarea></div>
                    <div class="mb-3"><label class="form-label">Jumlah</label><input type="number" class="form-control" id="jumlah" value="${data.jumlah || ''}" required></div>
                    <div class="mb-3"><label class="form-label">Keterangan</label><select class="form-select" id="keterangan" required><option disabled ${!isEdit && 'selected'} value="">Pilih...</option>
                        <option>Stock MME JKT</option>
                        <option>Stock MME SBY</option>
                        <option>MME JKT</option>
                        <option>MME SBY</option>
                    </select></div>`;
            } else if (currentCollectionName === 'material') {
                formHtml += `
                    <div class="mb-3"><label class="form-label">Nama Material</label><input type="text" class="form-control" id="nama" value="${data.nama || ''}" required></div>
                    <div class="mb-3"><label class="form-label">Merk</label><input type="text" class="form-control" id="merk" value="${data.merk || ''}" required></div>
                    <div class="mb-3"><label class="form-label">Spesifikasi</label><textarea class="form-control" id="spesifikasi">${data.spesifikasi || ''}</textarea></div>
                    <div class="mb-3"><label class="form-label">Jumlah</label><input type="number" class="form-control" id="jumlah" value="${data.jumlah || ''}" required></div>
                    <div class="mb-3"><label class="form-label">Keterangan</label><input type="text" class="form-control" id="keterangan" value="${data.keterangan || ''}" required></div>`;
            }
            itemForm.innerHTML = formHtml;
            if(isEdit) for(const key in data) if(document.getElementById(key)) document.getElementById(key).value = data[key];
        }
        
        function renderTableData(headers) {
            const tableBody = document.getElementById('table-body');
            const dataKeys = {
                'material': ['nama', 'merk', 'spesifikasi', 'jumlah', 'keterangan'],
                'komponen': ['nama_barang', 'merk', 'spesifikasi', 'jumlah', 'keterangan'],
                'keluar': ['nama_barang', 'merk', 'spesifikasi', 'jumlah', 'keterangan']
            }[currentCollectionName];

            const q = query(collection(db, 'users', user.uid, currentCollectionName));
            onSnapshot(q, (snapshot) => {
                tableBody.innerHTML = '';
                if (snapshot.empty) { tableBody.innerHTML = `<tr><td colspan="${headers.length + 2}" class="text-center">Tidak ada data.</td></tr>`; return; }
                let index = 1;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let rowHtml = `<td>${index++}</td>`;
                    dataKeys.forEach(key => rowHtml += `<td>${data[key] || ''}</td>`);
                    rowHtml += `<td><button class="btn btn-warning btn-sm btn-edit" data-id="${doc.id}"><i class="bi bi-pencil-square"></i></button> <button class="btn btn-danger btn-sm btn-delete" data-id="${doc.id}"><i class="bi bi-trash"></i></button></td>`;
                    tableBody.innerHTML += `<tr>${rowHtml}</tr>`;
                });
            });
        }

        function renderLogs() {
            const logContainer = document.querySelector('#log-container ul');
            if(!logContainer) return;
            const q = query(collection(db, 'users', user.uid, 'logs'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                const filteredLogs = snapshot.docs.filter(doc => doc.data().collection === currentCollectionName);
                if (filteredLogs.length === 0) { logContainer.innerHTML = '<li class="list-group-item text-muted text-center">Belum ada aktivitas untuk kategori ini.</li>'; return; }
                let logHtml = '';
                filteredLogs.forEach(doc => {
                    const log = doc.data();
                    const details = log.details || {};
                    const docName = details.nama || details.nama_barang || "Item";
                    const itemDetails = ` (Merk: ${details.merk || '-'}, Spek: ${details.spesifikasi || '-'}, Jml: ${details.jumlah || 0}, Ket: ${details.keterangan || '-'})`;
                    const date = log.timestamp?.toDate().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) || 'Baru saja';
                    logHtml += `<li class="list-group-item">[${date}] Item <strong>${docName}</strong> telah <strong>${log.action}</strong>.${itemDetails}</li>`;
                });
                logContainer.innerHTML = logHtml;
            });
        }

        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = document.getElementById('itemId').value;
            let data = {};
            itemForm.querySelectorAll('input, select, textarea').forEach(el => { if(el.id) data[el.id] = (el.type === 'number') ? Number(el.value) : el.value; });
            delete data.itemId;
            
            if (docId) { 
                await updateDoc(doc(db, 'users', user.uid, currentCollectionName, docId), data); 
                writeLog('Diperbarui', currentCollectionName, data);
            } else { 
                await addDoc(collection(db, 'users', user.uid, currentCollectionName), data); 
                writeLog('Ditambahkan', currentCollectionName, data);
            }
            itemModal.hide();
        });

        // Halaman awal saat aplikasi dimuat
        navigate('dashboard');
    }
</script>

</body>
</html>